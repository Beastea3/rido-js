var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { openDB } from 'idb';
import { KEY_STORAGE_DELEGATION, KEY_STORAGE_KEY } from './storage';
const AUTH_DB_NAME = 'auth-client-db';
const OBJECT_STORE_NAME = 'ic-keyval';
const _openDbStore = (dbName = AUTH_DB_NAME, storeName = OBJECT_STORE_NAME, version) => __awaiter(void 0, void 0, void 0, function* () {
    // Clear legacy stored delegations
    if (localStorage && localStorage.getItem(KEY_STORAGE_DELEGATION)) {
        localStorage.removeItem(KEY_STORAGE_DELEGATION);
        localStorage.removeItem(KEY_STORAGE_KEY);
    }
    return yield openDB(dbName, version, {
        upgrade: database => {
            database.objectStoreNames;
            if (database.objectStoreNames.contains(storeName)) {
                database.clear(storeName);
            }
            database.createObjectStore(storeName);
        },
    });
});
function _getValue(db, storeName, key) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield db.get(storeName, key);
    });
}
function _setValue(db, storeName, key, value) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield db.put(storeName, value, key);
    });
}
function _removeValue(db, storeName, key) {
    return __awaiter(this, void 0, void 0, function* () {
        return yield db.delete(storeName, key);
    });
}
/**
 * Simple Key Value store
 * Defaults to `'auth-client-db'` with an object store of `'ic-keyval'`
 */
export class IdbKeyVal {
    /**
     *
     * @param {DBCreateOptions} options {@link DbCreateOptions}
     * @param {DBCreateOptions['dbName']} options.dbName name for the indexeddb database
     * @default 'auth-client-db'
     * @param {DBCreateOptions['storeName']} options.storeName name for the indexeddb Data Store
     * @default 'ic-keyval'
     * @param {DBCreateOptions['version']} options.version version of the database. Increment to safely upgrade
     * @constructs an {@link IdbKeyVal}
     */
    static create(options) {
        return __awaiter(this, void 0, void 0, function* () {
            const { dbName = AUTH_DB_NAME, storeName = OBJECT_STORE_NAME, version = 1 } = options !== null && options !== void 0 ? options : {};
            const db = yield _openDbStore(dbName, storeName, version);
            return new IdbKeyVal(db, storeName);
        });
    }
    // Do not use - instead prefer create
    constructor(_db, _storeName) {
        this._db = _db;
        this._storeName = _storeName;
    }
    /**
     * Basic setter
     * @param {IDBValidKey} key string | number | Date | BufferSource | IDBValidKey[]
     * @param value value to set
     * @returns void
     */
    set(key, value) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield _setValue(this._db, this._storeName, key, value);
        });
    }
    /**
     * Basic getter
     * Pass in a type T for type safety if you know the type the value will have if it is found
     * @param {IDBValidKey} key string | number | Date | BufferSource | IDBValidKey[]
     * @returns `Promise<T | null>`
     * @example
     * await get<string>('exampleKey') -> 'exampleValue'
     */
    get(key) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            return (_a = (yield _getValue(this._db, this._storeName, key))) !== null && _a !== void 0 ? _a : null;
        });
    }
    /**
     * Remove a key
     * @param key {@link IDBValidKey}
     * @returns void
     */
    remove(key) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield _removeValue(this._db, this._storeName, key);
        });
    }
}
